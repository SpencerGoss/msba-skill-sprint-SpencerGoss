-- SQLite Customer Retention Analysis Tables
-- Normalized schema based on retentiondata_case.csv

-- Drop tables if they exist
DROP TABLE IF EXISTS churn_data;
DROP TABLE IF EXISTS billing_fees;
DROP TABLE IF EXISTS service_subscriptions;
DROP TABLE IF EXISTS account_contracts;
DROP TABLE IF EXISTS customers;

-- Table 1: Customers (Demographics)
CREATE TABLE customers (
    acct_ref TEXT PRIMARY KEY,
    cust_ref TEXT NOT NULL UNIQUE,
    gender TEXT,
    age_years INTEGER,
    is_married TEXT,
    has_dependents TEXT,
    dependents_count INTEGER,
    referred_friend TEXT,
    referrals_count INTEGER
);

-- Table 2: Service Subscriptions
CREATE TABLE service_subscriptions (
    service_id INTEGER PRIMARY KEY AUTOINCREMENT,
    acct_ref TEXT NOT NULL,
    internet_plan TEXT,
    home_phone TEXT,
    multi_line TEXT,
    add_on_security TEXT,
    add_on_backup TEXT,
    add_on_protection TEXT,
    tech_support_std TEXT,
    stream_tv TEXT,
    stream_movies TEXT,
    stream_music TEXT,
    unlimited_data_opt TEXT,
    premium_support TEXT,
    internet_tech TEXT,
    avg_gb_download INTEGER,
    FOREIGN KEY (acct_ref) REFERENCES customers(acct_ref)
);

-- Table 3: Account Contracts
CREATE TABLE account_contracts (
    account_id INTEGER PRIMARY KEY AUTOINCREMENT,
    acct_ref TEXT NOT NULL UNIQUE,
    contract_term TEXT,
    e_bill_opt_in TEXT,
    pay_method TEXT,
    tenure_mo INTEGER,
    recent_offer TEXT,
    fiscal_qtr TEXT,
    FOREIGN KEY (acct_ref) REFERENCES customers(acct_ref)
);

-- Table 4: Billing & Fees
CREATE TABLE billing_fees (
    bill_id INTEGER PRIMARY KEY AUTOINCREMENT,
    acct_ref TEXT NOT NULL,
    monthly_fee REAL,
    total_billed REAL,
    refunds_total REAL,
    extra_data_fees_total REAL,
    long_dist_fees_total REAL,
    avg_long_dist_fee REAL,
    FOREIGN KEY (acct_ref) REFERENCES customers(acct_ref)
);

-- Table 5: Churn Data
CREATE TABLE churn_data (
    churn_id INTEGER PRIMARY KEY AUTOINCREMENT,
    acct_ref TEXT NOT NULL UNIQUE,
    left_flag TEXT,
    FOREIGN KEY (acct_ref) REFERENCES customers(acct_ref)
);

-- Create indexes for frequently queried columns
CREATE INDEX idx_cust_ref ON customers(cust_ref);
CREATE INDEX idx_left_flag ON churn_data(left_flag);
CREATE INDEX idx_internet_plan ON service_subscriptions(internet_plan);
CREATE INDEX idx_contract_term ON account_contracts(contract_term);
CREATE INDEX idx_tenure ON account_contracts(tenure_mo);
CREATE INDEX idx_pay_method ON account_contracts(pay_method);
